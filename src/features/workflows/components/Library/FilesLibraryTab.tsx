/**
 * Copyright (c) 2025 Cade Russell (Ghost Peony)
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

/**
 * Files Library Tab
 *
 * Browse all files generated by agents across all projects and workflows.
 * Supports tree view and list view with search, filter, and file actions.
 */

import { useState, useEffect, useMemo, useCallback } from 'react';
import { Download, Trash2, Search, FolderOpen, ChevronRight, ChevronDown, List, TreeDeciduous, Eye, RefreshCw, Tag, Database, Link2, Copy, MoreVertical } from 'lucide-react';
import ReactMarkdown from 'react-markdown';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';
import { oneDark } from 'react-syntax-highlighter/dist/esm/styles/prism';
import { useProject } from '../../../../contexts/ProjectContext';

// Context menu types
interface ContextMenuState {
  visible: boolean;
  x: number;
  y: number;
  file: FileWithContext | null;
}

interface FileWithContext {
  filename: string;
  path: string;
  full_path: string;
  project_id: number | null;
  workflow_id: number | null;
  task_id: number | null;
  size_bytes: number;
  size_human: string;
  modified_at: string;
  extension: string;
  // Additional metadata (populated from DB if available)
  agent_label?: string | null;
  agent_type?: string | null;
  tags?: string[];
  metadata_id?: number | null;
}

interface FileContent {
  filename: string;
  content: string | null;
  mime_type: string;
  is_binary: boolean;
  truncated: boolean;
  size_bytes: number;
}

// File type icons
const getFileIcon = (extension: string): string => {
  const ext = extension.toLowerCase().replace('.', '');
  const icons: Record<string, string> = {
    md: 'üìù',
    txt: 'üìÑ',
    json: 'üìä',
    csv: 'üìä',
    py: 'üêç',
    js: 'üíõ',
    ts: 'üíô',
    tsx: 'üíô',
    jsx: 'üíõ',
    html: 'üåê',
    css: 'üé®',
    sql: 'üóÉÔ∏è',
    yaml: '‚öôÔ∏è',
    yml: '‚öôÔ∏è',
    xml: 'üìã',
    log: 'üìú',
    pdf: 'üìï',
    png: 'üñºÔ∏è',
    jpg: 'üñºÔ∏è',
    jpeg: 'üñºÔ∏è',
    gif: 'üñºÔ∏è',
    svg: 'üé®',
  };
  return icons[ext] || 'üìÑ';
};

// Get language for syntax highlighting
const getLanguage = (extension: string): string => {
  const ext = extension.toLowerCase().replace('.', '');
  const languages: Record<string, string> = {
    py: 'python',
    js: 'javascript',
    ts: 'typescript',
    tsx: 'tsx',
    jsx: 'jsx',
    json: 'json',
    html: 'html',
    css: 'css',
    sql: 'sql',
    yaml: 'yaml',
    yml: 'yaml',
    xml: 'xml',
    sh: 'bash',
    bash: 'bash',
  };
  return languages[ext] || 'text';
};

// Tree node structure
interface TreeNode {
  name: string;
  path: string;
  type: 'project' | 'workflow' | 'task' | 'file';
  id?: number | null;
  file?: FileWithContext;
  children: TreeNode[];
  expanded?: boolean;
}

export default function FilesLibraryTab() {
  const { projects } = useProject();
  const [files, setFiles] = useState<FileWithContext[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // View state
  const [viewMode, setViewMode] = useState<'tree' | 'list'>('tree');
  const [searchQuery, setSearchQuery] = useState('');
  const [sortBy, setSortBy] = useState<'name' | 'date' | 'size'>('date');
  const [sortDesc, setSortDesc] = useState(true);

  // Tree state
  const [expandedNodes, setExpandedNodes] = useState<Set<string>>(new Set());

  // Preview state
  const [selectedFile, setSelectedFile] = useState<FileWithContext | null>(null);
  const [fileContent, setFileContent] = useState<FileContent | null>(null);
  const [contentLoading, setContentLoading] = useState(false);
  const [previewOpen, setPreviewOpen] = useState(false);

  // Delete confirmation
  const [deleteConfirm, setDeleteConfirm] = useState<FileWithContext | null>(null);

  // Context menu state
  const [contextMenu, setContextMenu] = useState<ContextMenuState>({
    visible: false,
    x: 0,
    y: 0,
    file: null
  });

  // Tags edit modal
  const [tagsModalOpen, setTagsModalOpen] = useState(false);
  const [tagsModalFile, setTagsModalFile] = useState<FileWithContext | null>(null);
  const [editingTags, setEditingTags] = useState<string[]>([]);
  const [newTag, setNewTag] = useState('');

  // Close context menu on click outside
  useEffect(() => {
    const handleClick = () => setContextMenu(prev => ({ ...prev, visible: false }));
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') setContextMenu(prev => ({ ...prev, visible: false }));
    };

    if (contextMenu.visible) {
      document.addEventListener('click', handleClick);
      document.addEventListener('keydown', handleEscape);
      return () => {
        document.removeEventListener('click', handleClick);
        document.removeEventListener('keydown', handleEscape);
      };
    }
  }, [contextMenu.visible]);

  // Handle right-click on file
  const handleContextMenu = useCallback((e: React.MouseEvent, file: FileWithContext) => {
    e.preventDefault();
    e.stopPropagation();

    // Position context menu near click, but within viewport
    const menuWidth = 200;
    const menuHeight = 280;
    let x = e.clientX;
    let y = e.clientY;

    if (x + menuWidth > window.innerWidth) x = window.innerWidth - menuWidth - 10;
    if (y + menuHeight > window.innerHeight) y = window.innerHeight - menuHeight - 10;

    setContextMenu({ visible: true, x, y, file });
  }, []);

  // Knowledge base modal state
  const [kbModalOpen, setKbModalOpen] = useState(false);
  const [kbModalFile, setKbModalFile] = useState<FileWithContext | null>(null);
  const [kbProjectId, setKbProjectId] = useState<string>('');
  const [kbIndexing, setKbIndexing] = useState(false);

  // Context menu actions
  const handleAddToKnowledgeBase = async () => {
    if (!contextMenu.file) return;

    // If we know the project_id, use it. Otherwise, show modal to select
    if (contextMenu.file.project_id) {
      setKbProjectId(String(contextMenu.file.project_id));
    } else {
      setKbProjectId('');
    }

    setKbModalFile(contextMenu.file);
    setKbModalOpen(true);
    setContextMenu(prev => ({ ...prev, visible: false }));
  };

  const handleConfirmIndexToKnowledgeBase = async () => {
    if (!kbModalFile || !kbProjectId) return;

    setKbIndexing(true);

    try {
      // Call the indexing API
      const url = kbModalFile.task_id
        ? `/api/workspace/tasks/${kbModalFile.task_id}/files/${kbModalFile.filename}/index`
        : `/api/workspace/default/files/${kbModalFile.filename}/index`;

      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ project_id: parseInt(kbProjectId) })
      });

      const data = await response.json();

      if (response.ok && data.status === 'success') {
        alert(`Success! ${data.message}`);
      } else {
        alert(`Error: ${data.message || data.detail || 'Failed to index file'}`);
      }
    } catch (error) {
      console.error('Error indexing file:', error);
      alert('Failed to index file to knowledge base');
    } finally {
      setKbIndexing(false);
      setKbModalOpen(false);
      setKbModalFile(null);
    }
  };

  const handleAttachToWorkflow = async () => {
    if (!contextMenu.file) return;
    // TODO: Implement workflow attachment
    alert(`Attach to Workflow: ${contextMenu.file.filename}\n\nThis feature will add the file as context document to a selected workflow.`);
    setContextMenu(prev => ({ ...prev, visible: false }));
  };

  const handleCopyToProject = async () => {
    if (!contextMenu.file) return;
    // TODO: Implement copy to project
    alert(`Copy to Project: ${contextMenu.file.filename}\n\nThis feature will copy the file to another project's folder.`);
    setContextMenu(prev => ({ ...prev, visible: false }));
  };

  const handleEditTags = async () => {
    if (!contextMenu.file) return;

    // Fetch current metadata to get existing tags
    try {
      const response = await fetch(`/api/workspace/files/by-path?file_path=${encodeURIComponent(contextMenu.file.path)}`);
      if (response.ok) {
        const data = await response.json();
        if (data.has_metadata && data.metadata) {
          setEditingTags(data.metadata.tags || []);
        } else {
          setEditingTags([]);
        }
      } else {
        setEditingTags([]);
      }
    } catch {
      setEditingTags([]);
    }

    setTagsModalFile(contextMenu.file);
    setTagsModalOpen(true);
    setContextMenu(prev => ({ ...prev, visible: false }));
  };

  const handleSaveTags = async () => {
    if (!tagsModalFile) return;

    try {
      // First get the file metadata ID
      const response = await fetch(`/api/workspace/files/by-path?file_path=${encodeURIComponent(tagsModalFile.path)}`);
      if (response.ok) {
        const data = await response.json();
        if (data.has_metadata && data.metadata) {
          // Update the tags
          await fetch(`/api/workspace/files/metadata/${data.metadata.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tags: editingTags })
          });
        }
      }
    } catch (error) {
      console.error('Error saving tags:', error);
    }

    setTagsModalOpen(false);
    setTagsModalFile(null);
    setEditingTags([]);
  };

  const addTag = () => {
    if (newTag.trim() && !editingTags.includes(newTag.trim())) {
      setEditingTags([...editingTags, newTag.trim()]);
      setNewTag('');
    }
  };

  const removeTag = (tag: string) => {
    setEditingTags(editingTags.filter(t => t !== tag));
  };

  // Fetch all files
  useEffect(() => {
    fetchFiles();
  }, []);

  const fetchFiles = async () => {
    setLoading(true);
    setError(null);

    try {
      // Fetch files from filesystem
      const response = await fetch('/api/workspace/files');
      if (!response.ok) throw new Error('Failed to fetch files');
      const data = await response.json();
      const filesFromFs = data.files || [];

      // Also fetch metadata from database to get agent info
      try {
        const metadataResponse = await fetch('/api/workspace/files/with-metadata');
        if (metadataResponse.ok) {
          const metadataData = await metadataResponse.json();
          const metadataMap = new Map<string, any>();

          // Build a map of file_path -> metadata
          for (const meta of metadataData.files || []) {
            metadataMap.set(meta.file_path, meta);
          }

          // Enrich filesystem files with metadata
          for (const file of filesFromFs) {
            const metadata = metadataMap.get(file.path);
            if (metadata) {
              file.agent_label = metadata.agent_label;
              file.agent_type = metadata.agent_type;
              file.tags = metadata.tags;
              file.metadata_id = metadata.id;
            }
          }
        }
      } catch (metadataErr) {
        console.warn('Could not fetch file metadata:', metadataErr);
        // Continue without metadata - files will still be displayed
      }

      setFiles(filesFromFs);
    } catch (err) {
      console.error('Error fetching files:', err);
      setError(err instanceof Error ? err.message : 'Failed to load files');
    } finally {
      setLoading(false);
    }
  };

  // Fetch file content for preview
  const fetchFileContent = async (file: FileWithContext) => {
    setContentLoading(true);
    try {
      // Use different endpoint for default files (no task_id)
      const url = file.task_id
        ? `/api/workspace/tasks/${file.task_id}/files/${file.filename}/content`
        : `/api/workspace/default/files/${file.filename}/content`;

      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to fetch content');
      const data = await response.json();
      setFileContent(data);
    } catch (error) {
      console.error('Error fetching file content:', error);
      setFileContent(null);
    } finally {
      setContentLoading(false);
    }
  };

  // Handle file preview
  const handlePreview = (file: FileWithContext) => {
    setSelectedFile(file);
    setPreviewOpen(true);
    fetchFileContent(file);
  };

  // Handle download
  const handleDownload = (file: FileWithContext) => {
    // Use different endpoint for default files (no task_id)
    const url = file.task_id
      ? `/api/workspace/tasks/${file.task_id}/files/${file.filename}`
      : `/api/workspace/default/files/${file.filename}`;
    window.open(url, '_blank');
  };

  // Handle delete
  const handleDelete = async (file: FileWithContext) => {
    try {
      // Use different endpoint for default files (no task_id)
      const url = file.task_id
        ? `/api/workspace/tasks/${file.task_id}/files/${file.filename}`
        : `/api/workspace/default/files/${file.filename}`;

      const response = await fetch(url, {
        method: 'DELETE'
      });

      if (!response.ok) throw new Error('Failed to delete file');

      // Refresh files
      await fetchFiles();
      setDeleteConfirm(null);

      // Clear preview if deleted file was selected
      if (selectedFile?.path === file.path) {
        setSelectedFile(null);
        setFileContent(null);
        setPreviewOpen(false);
      }
    } catch (error) {
      console.error('Error deleting file:', error);
      alert('Failed to delete file.');
    }
  };

  // Filter and sort files
  const filteredFiles = useMemo(() => {
    let result = [...files];

    // Filter by search
    if (searchQuery.trim()) {
      const search = searchQuery.toLowerCase();
      result = result.filter(f => f.filename.toLowerCase().includes(search));
    }

    // Sort
    result.sort((a, b) => {
      let comparison = 0;
      switch (sortBy) {
        case 'name':
          comparison = a.filename.localeCompare(b.filename);
          break;
        case 'date':
          comparison = new Date(a.modified_at).getTime() - new Date(b.modified_at).getTime();
          break;
        case 'size':
          comparison = a.size_bytes - b.size_bytes;
          break;
      }
      return sortDesc ? -comparison : comparison;
    });

    return result;
  }, [files, searchQuery, sortBy, sortDesc]);

  // Build tree structure
  const treeData = useMemo(() => {
    const root: TreeNode[] = [];
    const projectMap = new Map<string, TreeNode>();
    const workflowMap = new Map<string, TreeNode>();
    const taskMap = new Map<string, TreeNode>();

    filteredFiles.forEach(file => {
      const projectKey = file.project_id !== null ? `project_${file.project_id}` : 'standalone';
      const workflowKey = file.workflow_id !== null ? `${projectKey}/workflow_${file.workflow_id}` : null;
      const taskKey = file.task_id !== null && workflowKey ? `${workflowKey}/task_${file.task_id}` : null;

      // Create/get project node
      if (!projectMap.has(projectKey)) {
        const projectNode: TreeNode = {
          name: file.project_id !== null ? `Project ${file.project_id}` : 'Standalone & Default',
          path: projectKey,
          type: 'project',
          id: file.project_id,
          children: [],
          expanded: expandedNodes.has(projectKey)
        };
        projectMap.set(projectKey, projectNode);
        root.push(projectNode);
      }

      if (!workflowKey || !taskKey) {
        // File in default directory (no workflow/task)
        const projectNode = projectMap.get(projectKey)!;
        projectNode.children.push({
          name: file.filename,
          path: file.path,
          type: 'file',
          file,
          children: []
        });
        return;
      }

      // Create/get workflow node
      if (!workflowMap.has(workflowKey)) {
        const workflowNode: TreeNode = {
          name: `Workflow ${file.workflow_id}`,
          path: workflowKey,
          type: 'workflow',
          id: file.workflow_id,
          children: [],
          expanded: expandedNodes.has(workflowKey)
        };
        workflowMap.set(workflowKey, workflowNode);
        projectMap.get(projectKey)!.children.push(workflowNode);
      }

      // Create/get task node
      if (!taskMap.has(taskKey)) {
        const taskNode: TreeNode = {
          name: `Task #${file.task_id}`,
          path: taskKey,
          type: 'task',
          id: file.task_id,
          children: [],
          expanded: expandedNodes.has(taskKey)
        };
        taskMap.set(taskKey, taskNode);
        workflowMap.get(workflowKey)!.children.push(taskNode);
      }

      // Add file to task
      taskMap.get(taskKey)!.children.push({
        name: file.filename,
        path: file.path,
        type: 'file',
        file,
        children: []
      });
    });

    return root;
  }, [filteredFiles, expandedNodes]);

  // Toggle tree node expansion
  const toggleNode = (path: string) => {
    setExpandedNodes(prev => {
      const next = new Set(prev);
      if (next.has(path)) {
        next.delete(path);
      } else {
        next.add(path);
      }
      return next;
    });
  };

  // Render tree node
  const renderTreeNode = (node: TreeNode, depth: number = 0): JSX.Element => {
    const isExpanded = expandedNodes.has(node.path);
    const hasChildren = node.children.length > 0;
    const paddingLeft = depth * 20;

    if (node.type === 'file' && node.file) {
      return (
        <div
          key={node.path}
          className={`flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-white/5 cursor-pointer group ${
            selectedFile?.path === node.path ? 'bg-primary/10' : ''
          }`}
          style={{ paddingLeft: paddingLeft + 28 }}
          onClick={() => handlePreview(node.file!)}
          onContextMenu={(e) => handleContextMenu(e, node.file!)}
        >
          <span className="text-base">{getFileIcon(node.file.extension)}</span>
          <div className="flex-1 min-w-0">
            <span className="text-sm text-gray-900 dark:text-white truncate block">{node.name}</span>
            {node.file.agent_label && (
              <span className="text-xs text-gray-500 dark:text-text-muted/70">
                by {node.file.agent_label}
              </span>
            )}
          </div>
          {node.file.tags && node.file.tags.length > 0 && (
            <div className="hidden group-hover:flex items-center gap-1 mr-1">
              {node.file.tags.slice(0, 2).map((tag) => (
                <span key={tag} className="px-1.5 py-0.5 text-[10px] rounded bg-primary/10 text-primary">
                  {tag}
                </span>
              ))}
              {node.file.tags.length > 2 && (
                <span className="text-[10px] text-gray-400">+{node.file.tags.length - 2}</span>
              )}
            </div>
          )}
          <span className="text-xs text-gray-500 dark:text-text-muted">{node.file.size_human}</span>
          <div className="hidden group-hover:flex items-center gap-1">
            <button
              onClick={(e) => { e.stopPropagation(); handleContextMenu(e, node.file!); }}
              className="p-1 rounded hover:bg-gray-200 dark:hover:bg-white/10"
              title="More actions"
            >
              <MoreVertical className="w-3.5 h-3.5 text-gray-500" />
            </button>
            <button
              onClick={(e) => { e.stopPropagation(); handleDownload(node.file!); }}
              className="p-1 rounded hover:bg-gray-200 dark:hover:bg-white/10"
              title="Download"
            >
              <Download className="w-3.5 h-3.5 text-gray-500" />
            </button>
            <button
              onClick={(e) => { e.stopPropagation(); setDeleteConfirm(node.file!); }}
              className="p-1 rounded hover:bg-red-100 dark:hover:bg-red-900/30"
              title="Delete"
            >
              <Trash2 className="w-3.5 h-3.5 text-red-500" />
            </button>
          </div>
        </div>
      );
    }

    const icon = node.type === 'project' ? 'üìÅ' : node.type === 'workflow' ? 'üîÑ' : 'üìã';
    const fileCount = countFiles(node);

    return (
      <div key={node.path}>
        <div
          className="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 dark:hover:bg-white/5 cursor-pointer"
          style={{ paddingLeft }}
          onClick={() => toggleNode(node.path)}
        >
          {hasChildren ? (
            isExpanded ? (
              <ChevronDown className="w-4 h-4 text-gray-400" />
            ) : (
              <ChevronRight className="w-4 h-4 text-gray-400" />
            )
          ) : (
            <div className="w-4" />
          )}
          <span className="text-base">{icon}</span>
          <span className="flex-1 text-sm font-medium text-gray-900 dark:text-white">{node.name}</span>
          <span className="text-xs text-gray-500 dark:text-text-muted">
            {fileCount} file{fileCount !== 1 ? 's' : ''}
          </span>
        </div>
        {isExpanded && node.children.map(child => renderTreeNode(child, depth + 1))}
      </div>
    );
  };

  // Count files recursively
  const countFiles = (node: TreeNode): number => {
    if (node.type === 'file') return 1;
    return node.children.reduce((sum, child) => sum + countFiles(child), 0);
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-full">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto mb-4" style={{ borderColor: 'var(--color-primary)' }}></div>
          <p className="text-sm text-gray-600 dark:text-text-muted">Loading files...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex flex-col items-center justify-center h-full text-center">
        <FolderOpen className="w-16 h-16 text-red-300 dark:text-red-900/30 mb-4" />
        <p className="text-lg font-medium text-red-600 dark:text-red-400">Failed to load files</p>
        <p className="text-sm text-gray-500 dark:text-text-muted/70 mt-2">{error}</p>
        <button
          onClick={fetchFiles}
          className="mt-4 px-4 py-2 rounded-lg bg-primary/10 hover:bg-primary/20 transition-colors text-sm font-medium flex items-center gap-2"
          style={{ color: 'var(--color-primary)' }}
        >
          <RefreshCw className="w-4 h-4" />
          Retry
        </button>
      </div>
    );
  }

  if (files.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-full text-center">
        <FolderOpen className="w-16 h-16 text-gray-300 dark:text-text-muted/30 mb-4" />
        <p className="text-lg font-medium text-gray-600 dark:text-text-muted">No files yet</p>
        <p className="text-sm text-gray-500 dark:text-text-muted/70 mt-2">
          Files created by agents during workflow execution will appear here.
        </p>
      </div>
    );
  }

  return (
    <div className="h-full flex flex-col">
      {/* Toolbar */}
      <div className="flex-shrink-0 flex items-center justify-between gap-4 p-4 border-b border-gray-200 dark:border-border-dark">
        <div className="flex items-center gap-3">
          {/* Search */}
          <div className="relative">
            <Search className="absolute left-2.5 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
            <input
              type="text"
              placeholder="Search files..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-8 pr-3 py-1.5 text-sm rounded-lg border border-gray-200 dark:border-border-dark bg-white dark:bg-panel-dark w-64 focus:outline-none focus:ring-2 focus:ring-primary/50"
            />
          </div>

          {/* Sort */}
          <select
            value={`${sortBy}-${sortDesc ? 'desc' : 'asc'}`}
            onChange={(e) => {
              const [sort, order] = e.target.value.split('-');
              setSortBy(sort as 'name' | 'date' | 'size');
              setSortDesc(order === 'desc');
            }}
            className="px-3 py-1.5 text-sm rounded-lg border border-gray-200 dark:border-border-dark bg-white dark:bg-panel-dark focus:outline-none focus:ring-2 focus:ring-primary/50"
          >
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
            <option value="name-asc">Name A-Z</option>
            <option value="name-desc">Name Z-A</option>
            <option value="size-desc">Largest First</option>
            <option value="size-asc">Smallest First</option>
          </select>
        </div>

        <div className="flex items-center gap-2">
          {/* Refresh */}
          <button
            onClick={fetchFiles}
            className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/10 transition-colors"
            title="Refresh"
          >
            <RefreshCw className="w-4 h-4 text-gray-600 dark:text-text-muted" />
          </button>

          {/* View Toggle */}
          <div className="flex border border-gray-200 dark:border-border-dark rounded-lg overflow-hidden">
            <button
              onClick={() => setViewMode('tree')}
              className={`px-3 py-1.5 text-sm flex items-center gap-1.5 ${
                viewMode === 'tree'
                  ? 'bg-primary/10 text-primary'
                  : 'text-gray-600 dark:text-text-muted hover:bg-gray-50 dark:hover:bg-white/5'
              }`}
              title="Tree View"
            >
              <TreeDeciduous className="w-4 h-4" />
              Tree
            </button>
            <button
              onClick={() => setViewMode('list')}
              className={`px-3 py-1.5 text-sm flex items-center gap-1.5 border-l border-gray-200 dark:border-border-dark ${
                viewMode === 'list'
                  ? 'bg-primary/10 text-primary'
                  : 'text-gray-600 dark:text-text-muted hover:bg-gray-50 dark:hover:bg-white/5'
              }`}
              title="List View"
            >
              <List className="w-4 h-4" />
              List
            </button>
          </div>
        </div>
      </div>

      {/* Content */}
      <div className="flex-1 flex overflow-hidden">
        {/* File Browser */}
        <div className={`${previewOpen ? 'w-1/2' : 'flex-1'} overflow-auto border-r border-gray-200 dark:border-border-dark`}>
          {viewMode === 'tree' ? (
            <div className="py-2">
              {treeData.map(node => renderTreeNode(node))}
            </div>
          ) : (
            <table className="w-full">
              <thead className="bg-gray-50 dark:bg-white/5 sticky top-0">
                <tr>
                  <th className="text-left px-4 py-2 text-xs font-semibold text-gray-600 dark:text-text-muted uppercase">Name</th>
                  <th className="text-left px-4 py-2 text-xs font-semibold text-gray-600 dark:text-text-muted uppercase">Created By</th>
                  <th className="text-left px-4 py-2 text-xs font-semibold text-gray-600 dark:text-text-muted uppercase">Location</th>
                  <th className="text-left px-4 py-2 text-xs font-semibold text-gray-600 dark:text-text-muted uppercase">Size</th>
                  <th className="text-left px-4 py-2 text-xs font-semibold text-gray-600 dark:text-text-muted uppercase">Modified</th>
                  <th className="w-28"></th>
                </tr>
              </thead>
              <tbody>
                {filteredFiles.map((file, index) => (
                  <tr
                    key={index}
                    className={`border-b border-gray-100 dark:border-border-dark hover:bg-gray-50 dark:hover:bg-white/5 cursor-pointer ${
                      selectedFile?.path === file.path ? 'bg-primary/10' : ''
                    }`}
                    onClick={() => handlePreview(file)}
                    onContextMenu={(e) => handleContextMenu(e, file)}
                  >
                    <td className="px-4 py-2.5">
                      <div className="flex items-center gap-2">
                        <span className="text-base">{getFileIcon(file.extension)}</span>
                        <div className="min-w-0">
                          <span className="text-sm font-medium text-gray-900 dark:text-white block truncate">{file.filename}</span>
                          {file.tags && file.tags.length > 0 && (
                            <div className="flex items-center gap-1 mt-0.5">
                              {file.tags.slice(0, 3).map((tag) => (
                                <span key={tag} className="px-1.5 py-0.5 text-[10px] rounded bg-primary/10 text-primary">
                                  {tag}
                                </span>
                              ))}
                              {file.tags.length > 3 && (
                                <span className="text-[10px] text-gray-400">+{file.tags.length - 3}</span>
                              )}
                            </div>
                          )}
                        </div>
                      </div>
                    </td>
                    <td className="px-4 py-2.5">
                      {file.agent_label ? (
                        <span className="inline-flex items-center gap-1 px-2 py-0.5 text-xs rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                          ü§ñ {file.agent_label}
                        </span>
                      ) : (
                        <span className="text-xs text-gray-400">‚Äî</span>
                      )}
                    </td>
                    <td className="px-4 py-2.5">
                      <span className="text-xs text-gray-500 dark:text-text-muted">
                        {file.project_id !== null ? `Project ${file.project_id}` : 'Default'}{' '}
                        {file.workflow_id !== null ? `‚Ä∫ Workflow ${file.workflow_id}` : ''}{' '}
                        {file.task_id !== null ? `‚Ä∫ Task ${file.task_id}` : ''}
                      </span>
                    </td>
                    <td className="px-4 py-2.5 text-sm text-gray-600 dark:text-text-muted">{file.size_human}</td>
                    <td className="px-4 py-2.5 text-sm text-gray-600 dark:text-text-muted">
                      {new Date(file.modified_at).toLocaleDateString()}
                    </td>
                    <td className="px-4 py-2.5">
                      <div className="flex items-center gap-1 justify-end">
                        <button
                          onClick={(e) => { e.stopPropagation(); handleContextMenu(e, file); }}
                          className="p-1.5 rounded hover:bg-gray-200 dark:hover:bg-white/10"
                          title="More actions"
                        >
                          <MoreVertical className="w-4 h-4 text-gray-500" />
                        </button>
                        <button
                          onClick={(e) => { e.stopPropagation(); handleDownload(file); }}
                          className="p-1.5 rounded hover:bg-gray-200 dark:hover:bg-white/10"
                          title="Download"
                        >
                          <Download className="w-4 h-4 text-gray-500" />
                        </button>
                        <button
                          onClick={(e) => { e.stopPropagation(); setDeleteConfirm(file); }}
                          className="p-1.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30"
                          title="Delete"
                        >
                          <Trash2 className="w-4 h-4 text-red-500" />
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>

        {/* Preview Panel */}
        {previewOpen && selectedFile && (
          <div className="w-1/2 flex flex-col overflow-hidden">
            {/* Preview Header */}
            <div className="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200 dark:border-border-dark">
              <div className="flex items-center gap-2 min-w-0">
                <span className="text-xl">{getFileIcon(selectedFile.extension)}</span>
                <h3 className="font-semibold text-gray-900 dark:text-white truncate">{selectedFile.filename}</h3>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => handleDownload(selectedFile)}
                  className="p-1.5 rounded hover:bg-gray-100 dark:hover:bg-white/10"
                  title="Download"
                >
                  <Download className="w-4 h-4 text-gray-600 dark:text-text-muted" />
                </button>
                <button
                  onClick={() => { setPreviewOpen(false); setSelectedFile(null); setFileContent(null); }}
                  className="p-1.5 rounded hover:bg-gray-100 dark:hover:bg-white/10"
                  title="Close preview"
                >
                  <span className="text-xl text-gray-400">√ó</span>
                </button>
              </div>
            </div>

            {/* Preview Content */}
            <div className="flex-1 overflow-auto p-4 bg-gray-50 dark:bg-black/20">
              {contentLoading ? (
                <div className="flex items-center justify-center h-full">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2" style={{ borderColor: 'var(--color-primary)' }}></div>
                </div>
              ) : fileContent?.is_binary ? (
                <div className="flex flex-col items-center justify-center h-full text-center">
                  <span className="text-4xl mb-3">{getFileIcon(selectedFile.extension)}</span>
                  <p className="text-gray-600 dark:text-text-muted">Binary file - preview not available</p>
                  <p className="text-sm text-gray-500 dark:text-text-muted/70 mt-1">{selectedFile.size_human}</p>
                  <button
                    onClick={() => handleDownload(selectedFile)}
                    className="mt-4 px-4 py-2 rounded-lg bg-primary/10 hover:bg-primary/20 transition-colors text-sm font-medium flex items-center gap-2"
                    style={{ color: 'var(--color-primary)' }}
                  >
                    <Download className="w-4 h-4" />
                    Download to view
                  </button>
                </div>
              ) : fileContent?.content ? (
                <div>
                  {selectedFile.extension === '.md' ? (
                    <div className="prose prose-sm max-w-none" style={{ color: '#1f2937' }}>
                      <ReactMarkdown>{fileContent.content}</ReactMarkdown>
                    </div>
                  ) : ['json', 'py', 'js', 'ts', 'tsx', 'jsx', 'html', 'css', 'sql', 'yaml', 'yml', 'xml', 'sh', 'bash'].includes(selectedFile.extension.replace('.', '').toLowerCase()) ? (
                    <SyntaxHighlighter
                      language={getLanguage(selectedFile.extension)}
                      style={oneDark}
                      customStyle={{ margin: 0, borderRadius: '0.5rem', fontSize: '0.8rem' }}
                      showLineNumbers
                    >
                      {fileContent.content}
                    </SyntaxHighlighter>
                  ) : (
                    <pre className="text-sm whitespace-pre-wrap break-words font-mono" style={{ color: '#1f2937' }}>
                      {fileContent.content}
                    </pre>
                  )}
                  {fileContent.truncated && (
                    <div className="mt-4 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800/30 rounded text-sm text-yellow-800 dark:text-yellow-200">
                      File content truncated. Download to see full content.
                    </div>
                  )}
                </div>
              ) : (
                <div className="flex items-center justify-center h-full text-gray-500 dark:text-text-muted">
                  Unable to load file content
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {/* Delete Confirmation Modal */}
      {deleteConfirm && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div
            className="rounded-lg p-6 max-w-md mx-4 shadow-xl border"
            style={{
              backgroundColor: 'var(--color-background-light)',
              borderColor: 'var(--color-border-dark)'
            }}
          >
            <h3
              className="text-lg font-semibold mb-2"
              style={{ color: 'var(--color-text-primary)' }}
            >
              Delete File?
            </h3>
            <p
              className="text-sm mb-4"
              style={{ color: 'var(--color-text-muted)' }}
            >
              Are you sure you want to delete "{deleteConfirm.filename}"? This action cannot be undone.
            </p>
            <div className="flex justify-end gap-3">
              <button
                onClick={() => setDeleteConfirm(null)}
                className="px-4 py-2 text-sm rounded-lg border transition-colors"
                style={{
                  borderColor: 'var(--color-border-dark)',
                  color: 'var(--color-text-primary)'
                }}
              >
                Cancel
              </button>
              <button
                onClick={() => handleDelete(deleteConfirm)}
                className="px-4 py-2 text-sm rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Context Menu */}
      {contextMenu.visible && contextMenu.file && (
        <div
          className="fixed z-50 w-56 rounded-lg shadow-xl border py-1"
          style={{
            left: contextMenu.x,
            top: contextMenu.y,
            backgroundColor: 'var(--color-background-light, #ffffff)',
            borderColor: 'var(--color-border-dark, #e5e7eb)',
            boxShadow: '0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2)'
          }}
          onClick={(e) => e.stopPropagation()}
        >
          <div
            className="px-4 py-2 border-b"
            style={{ borderColor: 'var(--color-border-dark, #e5e7eb)' }}
          >
            <div
              className="text-xs font-semibold uppercase truncate"
              style={{ color: 'var(--color-text-muted)' }}
            >
              {contextMenu.file.filename}
            </div>
          </div>

          <button
            onClick={() => { handlePreview(contextMenu.file!); setContextMenu(prev => ({ ...prev, visible: false })); }}
            className="w-full flex items-center gap-3 px-4 py-2.5 text-sm transition-all duration-150 hover:bg-primary/10 hover:pl-5"
            style={{ color: 'var(--color-text-primary)' }}
          >
            <Eye className="w-4 h-4" style={{ color: 'var(--color-text-muted)' }} />
            <span className="font-medium">Preview</span>
          </button>

          <button
            onClick={() => { handleDownload(contextMenu.file!); setContextMenu(prev => ({ ...prev, visible: false })); }}
            className="w-full flex items-center gap-3 px-4 py-2.5 text-sm transition-all duration-150 hover:bg-primary/10 hover:pl-5"
            style={{ color: 'var(--color-text-primary)' }}
          >
            <Download className="w-4 h-4" style={{ color: 'var(--color-text-muted)' }} />
            <span className="font-medium">Download</span>
          </button>

          <div className="my-1 border-t" style={{ borderColor: 'var(--color-border-dark, #e5e7eb)' }} />

          <button
            onClick={handleAddToKnowledgeBase}
            className="w-full flex items-center gap-3 px-4 py-2.5 text-sm transition-all duration-150 hover:bg-primary/10 hover:pl-5"
            style={{ color: 'var(--color-text-primary)' }}
          >
            <Database className="w-4 h-4" style={{ color: 'var(--color-text-muted)' }} />
            <span className="font-medium">Add to Knowledge Base</span>
          </button>

          <button
            onClick={handleAttachToWorkflow}
            className="w-full flex items-center gap-3 px-4 py-2.5 text-sm transition-all duration-150 hover:bg-primary/10 hover:pl-5"
            style={{ color: 'var(--color-text-primary)' }}
          >
            <Link2 className="w-4 h-4" style={{ color: 'var(--color-text-muted)' }} />
            <span className="font-medium">Attach to Workflow</span>
          </button>

          <button
            onClick={handleCopyToProject}
            className="w-full flex items-center gap-3 px-4 py-2.5 text-sm transition-all duration-150 hover:bg-primary/10 hover:pl-5"
            style={{ color: 'var(--color-text-primary)' }}
          >
            <Copy className="w-4 h-4" style={{ color: 'var(--color-text-muted)' }} />
            <span className="font-medium">Copy to Project...</span>
          </button>

          <div className="my-1 border-t" style={{ borderColor: 'var(--color-border-dark, #e5e7eb)' }} />

          <button
            onClick={handleEditTags}
            className="w-full flex items-center gap-3 px-4 py-2.5 text-sm transition-all duration-150 hover:bg-primary/10 hover:pl-5"
            style={{ color: 'var(--color-text-primary)' }}
          >
            <Tag className="w-4 h-4" style={{ color: 'var(--color-text-muted)' }} />
            <span className="font-medium">Edit Tags</span>
          </button>

          <div className="my-1 border-t" style={{ borderColor: 'var(--color-border-dark, #e5e7eb)' }} />

          <button
            onClick={() => { setDeleteConfirm(contextMenu.file!); setContextMenu(prev => ({ ...prev, visible: false })); }}
            className="w-full flex items-center gap-3 px-4 py-2.5 text-sm transition-all duration-150 hover:bg-red-50 dark:hover:bg-red-500/20 text-red-600 dark:text-red-400 hover:pl-5"
          >
            <Trash2 className="w-4 h-4" />
            <span className="font-medium">Delete</span>
          </button>
        </div>
      )}

      {/* Tags Edit Modal */}
      {tagsModalOpen && tagsModalFile && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div
            className="rounded-lg p-6 max-w-md w-full mx-4 shadow-xl border"
            style={{
              backgroundColor: 'var(--color-background-light)',
              borderColor: 'var(--color-border-dark)'
            }}
          >
            <h3
              className="text-lg font-semibold mb-2"
              style={{ color: 'var(--color-text-primary)' }}
            >
              Edit Tags
            </h3>
            <p
              className="text-sm mb-4"
              style={{ color: 'var(--color-text-muted)' }}
            >
              Add tags to "{tagsModalFile.filename}" for easy filtering.
            </p>

            {/* Current tags */}
            <div className="flex flex-wrap gap-2 mb-4 min-h-8">
              {editingTags.map((tag) => (
                <span
                  key={tag}
                  className="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-full bg-primary/10"
                  style={{ color: 'var(--color-primary)' }}
                >
                  {tag}
                  <button
                    onClick={() => removeTag(tag)}
                    className="hover:text-red-500"
                  >
                    √ó
                  </button>
                </span>
              ))}
              {editingTags.length === 0 && (
                <span className="text-sm" style={{ color: 'var(--color-text-muted)' }}>No tags yet</span>
              )}
            </div>

            {/* Add new tag */}
            <div className="flex gap-2 mb-4">
              <input
                type="text"
                placeholder="Add a tag..."
                value={newTag}
                onChange={(e) => setNewTag(e.target.value)}
                onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); addTag(); } }}
                className="flex-1 px-3 py-2 text-sm rounded-lg border focus:outline-none focus:ring-2 focus:ring-primary/50"
                style={{
                  backgroundColor: 'var(--color-input-background)',
                  borderColor: 'var(--color-border-dark)',
                  color: 'var(--color-text-primary)'
                }}
              />
              <button
                onClick={addTag}
                className="px-4 py-2 text-sm rounded-lg bg-primary/10 hover:bg-primary/20 transition-colors"
                style={{ color: 'var(--color-primary)' }}
              >
                Add
              </button>
            </div>

            <div className="flex justify-end gap-3">
              <button
                onClick={() => { setTagsModalOpen(false); setTagsModalFile(null); setEditingTags([]); }}
                className="px-4 py-2 text-sm rounded-lg border transition-colors"
                style={{
                  borderColor: 'var(--color-border-dark)',
                  color: 'var(--color-text-primary)'
                }}
              >
                Cancel
              </button>
              <button
                onClick={handleSaveTags}
                className="px-4 py-2 text-sm rounded-lg text-white transition-colors"
                style={{ backgroundColor: 'var(--color-primary)' }}
              >
                Save Tags
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Knowledge Base Modal */}
      {kbModalOpen && kbModalFile && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div
            className="rounded-lg p-6 max-w-md w-full mx-4 shadow-xl border"
            style={{
              backgroundColor: 'var(--color-background-light)',
              borderColor: 'var(--color-border-dark)'
            }}
          >
            <h3
              className="text-lg font-semibold mb-2"
              style={{ color: 'var(--color-text-primary)' }}
            >
              Add to Knowledge Base
            </h3>
            <p
              className="text-sm mb-4"
              style={{ color: 'var(--color-text-muted)' }}
            >
              Index "{kbModalFile.filename}" into a project's knowledge base for RAG queries.
            </p>

            <div className="mb-4">
              <label
                className="block text-sm font-medium mb-2"
                style={{ color: 'var(--color-text-primary)' }}
              >
                Select Project
              </label>
              <select
                value={kbProjectId}
                onChange={(e) => setKbProjectId(e.target.value)}
                className="w-full px-3 py-2.5 text-sm rounded-lg border focus:outline-none focus:ring-2 focus:ring-primary/50"
                style={{
                  backgroundColor: 'var(--color-input-background)',
                  borderColor: 'var(--color-border-dark)',
                  color: 'var(--color-text-primary)'
                }}
              >
                <option value="">Choose a project...</option>
                {projects.map((project) => (
                  <option key={project.id} value={String(project.id)}>
                    {project.name}
                  </option>
                ))}
              </select>
              <p
                className="text-xs mt-2"
                style={{ color: 'var(--color-text-muted)' }}
              >
                The file will be chunked and indexed into this project's vector store for semantic search.
              </p>
            </div>

            <div className="flex justify-end gap-3">
              <button
                onClick={() => { setKbModalOpen(false); setKbModalFile(null); setKbProjectId(''); }}
                className="px-4 py-2 text-sm rounded-lg border transition-colors"
                style={{
                  borderColor: 'var(--color-border-dark)',
                  color: 'var(--color-text-primary)'
                }}
                disabled={kbIndexing}
              >
                Cancel
              </button>
              <button
                onClick={handleConfirmIndexToKnowledgeBase}
                disabled={!kbProjectId || kbIndexing}
                className="px-4 py-2 text-sm rounded-lg text-white flex items-center gap-2 disabled:opacity-50 transition-colors"
                style={{ backgroundColor: 'var(--color-primary)' }}
              >
                {kbIndexing ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    Indexing...
                  </>
                ) : (
                  <>
                    <Database className="w-4 h-4" />
                    Index File
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
