/**
 * Copyright (c) 2025 Cade Russell (Ghost Peony)
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

/**
 * Files Tab
 *
 * Displays workspace files generated by workflow executions.
 * Supports multi-file selection for creating presentations.
 */

import { useState, useCallback, useMemo } from 'react';
import { CheckSquare, Square, X, Presentation } from 'lucide-react';
import InlineFilePreview, { FileContent } from '@/features/workflows/execution/InlineFilePreview';
import { getFileIcon } from '../../utils/fileHelpers';
import { useSelection, createFileSelectionItem } from '../context/SelectionContext';
import type { TaskFile } from '../hooks/useFileHandling';

interface FilesTabProps {
  files: TaskFile[];
  filesLoading: boolean;
  filesError: string | null;
  selectedPreviewFile: TaskFile | null;
  filePreviewContent: FileContent | null;
  filePreviewLoading: boolean;
  currentTaskId: number | null;
  fetchFiles: () => Promise<void>;
  handleDownloadFile: (filename: string) => void;
  handleFileSelect: (file: TaskFile) => void;
  closeFilePreview: () => void;
  onCreatePresentation?: () => void;
}

export default function FilesTab({
  files,
  filesLoading,
  filesError,
  selectedPreviewFile,
  filePreviewContent,
  filePreviewLoading,
  currentTaskId,
  fetchFiles,
  handleDownloadFile,
  handleFileSelect,
  closeFilePreview,
  onCreatePresentation,
}: FilesTabProps) {
  const {
    isSelecting,
    setIsSelecting,
    toggleSelection,
    selectAll,
    clearSelection,
    isSelected,
    selectedCount,
    getSelectedByType,
  } = useSelection();

  // Local selection mode state for files
  const [localIsSelecting, setLocalIsSelecting] = useState(false);
  const effectiveIsSelecting = isSelecting || localIsSelecting;

  // Count of selected files
  const selectedFileCount = useMemo(() => {
    return getSelectedByType('file').length;
  }, [getSelectedByType]);

  // Check if a file is selected
  const isFileSelected = useCallback((file: TaskFile) => {
    const key = `file-${currentTaskId}-${file.path}`;
    return isSelected(key);
  }, [currentTaskId, isSelected]);

  // Toggle file selection
  const handleToggleFileSelection = useCallback((file: TaskFile, e: React.MouseEvent) => {
    e.stopPropagation();
    if (!currentTaskId) return;

    const selectionItem = createFileSelectionItem(
      currentTaskId,
      file.filename,
      file.path,
      file.size_bytes,
      file.extension
    );
    toggleSelection(selectionItem);
  }, [currentTaskId, toggleSelection]);

  // Select all files
  const handleSelectAll = useCallback(() => {
    if (!currentTaskId) return;

    const selectionItems = files.map(file =>
      createFileSelectionItem(
        currentTaskId,
        file.filename,
        file.path,
        file.size_bytes,
        file.extension
      )
    );
    selectAll(selectionItems);
  }, [currentTaskId, files, selectAll]);

  // Cancel selection
  const handleCancelSelection = useCallback(() => {
    clearSelection();
    setLocalIsSelecting(false);
  }, [clearSelection]);

  // Enter selection mode
  const handleEnterSelection = useCallback(() => {
    setIsSelecting(true);
    setLocalIsSelecting(true);
  }, [setIsSelecting]);

  if (filesLoading) {
    return (
      <div className="flex items-center justify-center py-16">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4" style={{ borderColor: 'var(--color-primary)' }}></div>
          <p className="text-sm" style={{ color: 'var(--color-text-muted)' }}>Loading files...</p>
        </div>
      </div>
    );
  }

  if (filesError) {
    return (
      <div className="flex flex-col items-center justify-center py-16 text-center">
        <span className="material-symbols-outlined text-6xl text-red-300 dark:text-red-900/30 mb-4">
          error
        </span>
        <p className="text-lg font-medium text-red-600 dark:text-red-400">
          Failed to load files
        </p>
        <p className="text-sm mt-2" style={{ color: 'var(--color-text-muted)' }}>
          {filesError}
        </p>
        <button
          onClick={fetchFiles}
          className="mt-4 px-4 py-2 rounded-lg bg-primary/10 hover:bg-primary/20 transition-colors text-sm font-medium"
          style={{ color: 'var(--color-primary)' }}
        >
          Retry
        </button>
      </div>
    );
  }

  if (files.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-16 text-center">
        <span className="material-symbols-outlined text-6xl mb-4" style={{ color: 'var(--color-text-muted)', opacity: 0.3 }}>
          folder_open
        </span>
        <p className="text-lg font-medium" style={{ color: 'var(--color-text-muted)' }}>
          No files generated
        </p>
        <p className="text-sm mt-2" style={{ color: 'var(--color-text-muted)', opacity: 0.7 }}>
          This workflow hasn't created any output files yet.
        </p>
      </div>
    );
  }

  return (
    <div className="flex-1 overflow-hidden flex flex-col">
      {/* Selection Toolbar */}
      {files.length > 0 && (
        <div className="flex items-center justify-between px-6 py-3 border-b" style={{ borderColor: 'var(--color-border-dark)' }}>
          <div>
            <p className="text-sm" style={{ color: 'var(--color-text-muted)' }}>
              {effectiveIsSelecting
                ? `${selectedFileCount} file${selectedFileCount !== 1 ? 's' : ''} selected`
                : `Click a file to preview. ${files.length} file${files.length !== 1 ? 's' : ''} generated.`
              }
            </p>
          </div>

          <div className="flex items-center gap-2">
            {effectiveIsSelecting ? (
              <>
                {/* Select All */}
                <button
                  onClick={handleSelectAll}
                  className="px-3 py-1.5 text-sm flex items-center gap-1.5 rounded-lg border transition-colors hover:bg-white/5"
                  style={{ borderColor: 'var(--color-border-dark)', color: 'var(--color-text-muted)' }}
                  title={selectedFileCount === files.length ? "Deselect All" : "Select All"}
                >
                  {selectedFileCount === files.length ? (
                    <CheckSquare className="w-4 h-4" style={{ color: 'var(--color-primary)' }} />
                  ) : (
                    <Square className="w-4 h-4" />
                  )}
                  {selectedFileCount === files.length ? 'Deselect All' : 'Select All'}
                </button>

                {/* Create Presentation */}
                {selectedCount > 0 && onCreatePresentation && (
                  <button
                    onClick={onCreatePresentation}
                    className="px-3 py-1.5 text-sm flex items-center gap-1.5 rounded-lg transition-colors bg-primary hover:bg-primary/90"
                    style={{ color: 'white' }}
                    title="Create presentation from selected items"
                  >
                    <Presentation className="w-4 h-4" />
                    Create Presentation
                  </button>
                )}

                {/* Cancel */}
                <button
                  onClick={handleCancelSelection}
                  className="px-3 py-1.5 text-sm flex items-center gap-1.5 rounded-lg border transition-colors hover:bg-white/5"
                  style={{ borderColor: 'var(--color-border-dark)', color: 'var(--color-text-muted)' }}
                  title="Cancel selection"
                >
                  <X className="w-4 h-4" />
                  Cancel
                </button>
              </>
            ) : (
              <>
                {/* Enter Selection Mode */}
                <button
                  onClick={handleEnterSelection}
                  className="px-3 py-1.5 text-sm flex items-center gap-1.5 rounded-lg border transition-colors hover:bg-white/5"
                  style={{ borderColor: 'var(--color-border-dark)', color: 'var(--color-text-muted)' }}
                  title="Select files for presentation"
                >
                  <CheckSquare className="w-4 h-4" />
                  Select
                </button>
              </>
            )}
          </div>
        </div>
      )}

      {/* Files Content */}
      <div className="flex-1 overflow-hidden flex">
        <div className={`${selectedPreviewFile ? 'w-1/2' : 'w-full'} overflow-y-auto p-6 transition-all duration-200`}>
          <div className="space-y-2">
            {files.map((file, index) => (
              <div
                key={index}
                onClick={() => effectiveIsSelecting ? handleToggleFileSelection(file, { stopPropagation: () => {} } as React.MouseEvent) : handleFileSelect(file)}
                className={`flex items-center justify-between p-4 rounded-lg border cursor-pointer transition-all ${
                  isFileSelected(file)
                    ? 'border-primary/50 bg-primary/5 ring-2 ring-primary/20'
                    : selectedPreviewFile?.path === file.path
                      ? 'border-primary/50 bg-primary/5 ring-2 ring-primary/20'
                      : 'hover:bg-gray-50 dark:hover:bg-white/5'
                }`}
                style={{ borderColor: (isFileSelected(file) || selectedPreviewFile?.path === file.path) ? undefined : 'var(--color-border-dark)' }}
              >
                {/* Selection Checkbox */}
                {effectiveIsSelecting && (
                  <div
                    className="mr-3 flex-shrink-0"
                    onClick={(e) => handleToggleFileSelection(file, e)}
                  >
                    <div className={`w-6 h-6 rounded-md flex items-center justify-center transition-colors ${
                      isFileSelected(file)
                        ? 'bg-primary'
                        : 'bg-gray-200 dark:bg-white/10 hover:bg-gray-300 dark:hover:bg-white/20'
                    }`}>
                      {isFileSelected(file) ? (
                        <CheckSquare className="w-4 h-4 text-white" />
                      ) : (
                        <Square className="w-4 h-4" style={{ color: 'var(--color-text-muted)' }} />
                      )}
                    </div>
                  </div>
                )}

                <div className="flex items-center gap-3 flex-1 min-w-0">
                  <span className="text-2xl flex-shrink-0">{getFileIcon(file.extension)}</span>
                  <div className="flex-1 min-w-0">
                    <p className="font-medium truncate" style={{ color: 'var(--color-text-primary)' }}>
                      {file.filename}
                    </p>
                    <div className="flex items-center gap-3 text-xs mt-1" style={{ color: 'var(--color-text-muted)' }}>
                      <span>{file.size_human}</span>
                      <span>•</span>
                      <span>{new Date(file.modified_at).toLocaleDateString()}</span>
                      {file.extension && (
                        <>
                          <span>•</span>
                          <span className="uppercase">{file.extension.replace('.', '')}</span>
                        </>
                      )}
                    </div>
                  </div>
                </div>

                {!effectiveIsSelecting && (
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      handleDownloadFile(file.filename);
                    }}
                    className="ml-4 px-3 py-2 rounded-lg bg-gray-100 dark:bg-white/5 hover:bg-gray-200 dark:hover:bg-white/10 transition-colors flex items-center gap-2 text-sm font-medium"
                    style={{ color: 'var(--color-text-muted)' }}
                    title="Download file"
                  >
                    <span className="material-symbols-outlined text-base">download</span>
                    {!selectedPreviewFile && 'Download'}
                  </button>
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Preview Panel */}
        {selectedPreviewFile && (
          <InlineFilePreview
            file={selectedPreviewFile}
            content={filePreviewContent}
            loading={filePreviewLoading}
            onClose={closeFilePreview}
            onDownload={handleDownloadFile}
          />
        )}
      </div>
    </div>
  );
}
